<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConjurMuleConnectionProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Conjur MuleSoft Custom Connector</a> &gt; <a href="index.source.html" class="el_package">com.cyberark.conjur.mulesoft.internal</a> &gt; <span class="el_source">ConjurMuleConnectionProvider.java</span></div><h1>ConjurMuleConnectionProvider.java</h1><pre class="source lang-java linenums">package com.cyberark.conjur.mulesoft.internal;

import java.util.UUID;

import org.apache.commons.lang3.StringUtils;
import org.mule.runtime.api.connection.CachedConnectionProvider;
import org.mule.runtime.api.connection.ConnectionException;
import org.mule.runtime.api.connection.ConnectionProvider;
import org.mule.runtime.api.connection.ConnectionValidationResult;
import org.mule.runtime.api.connection.PoolingConnectionProvider;
import org.mule.runtime.extension.api.annotation.error.Throws;
import org.mule.runtime.extension.api.annotation.param.Optional;
import org.mule.runtime.extension.api.annotation.param.Parameter;
import org.mule.runtime.extension.api.annotation.param.stereotype.Validator;
import org.mule.runtime.extension.api.exception.ModuleException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.cyberark.conjur.constant.ConjurConstant;
import com.cyberark.conjur.core.ConjurConnection;
import com.cyberark.conjur.domain.ConjurConfiguration;
import com.cyberark.conjur.error.ConjurErrorProvider;
import com.cyberark.conjur.error.ConjurErrorTypes;
import com.cyberark.conjur.sdk.ApiException;
import com.cyberark.conjur.sdk.endpoint.SecretsApi;
import com.cyberark.conjur.service.ConjurService;
import com.cyberark.conjur.service.ConjurServiceImpl;

/**
 * This class (as it's name implies) provides connection instances and the
 * funcionality to disconnect and validate those connections.
 * &lt;p&gt;
 * All connection related parameters (values required in order to create a
 * connection) must be declared in the connection providers.
 * &lt;p&gt;
 * This particular example is a {@link PoolingConnectionProvider} which declares
 * that connections resolved by this provider will be pooled and reused. There
 * are other implementations like {@link CachedConnectionProvider} which lazily
 * creates and caches connections or simply {@link ConnectionProvider} if you
 * want a new connection each time something requires one.
 */

<span class="fc" id="L43">public class ConjurMuleConnectionProvider implements ConnectionProvider&lt;ConjurMuleConnection&gt; {</span>

<span class="fc" id="L45">	private final Logger LOGGER = LoggerFactory.getLogger(ConjurMuleConnectionProvider.class);</span>

	/**
	 * A parameter that is always required to be configured.
	 */
	@Parameter
	private String conjurAccount;
	@Parameter
	private String conjurApplianceUrl;
	@Parameter
	private String conjurAuthnLogin;
	@Parameter
	@Optional
	private String conjurApiKey;
	@Parameter
	@Optional
	private String conjurSslCertificate;
	@Parameter
	@Optional
	private String conjurCertFile;
	@Parameter
	private String key;

<span class="fc" id="L68">	private SecretsApi secretsApi = new SecretsApi();</span>
<span class="fc" id="L69">	ConjurService conjurService = new ConjurServiceImpl();</span>

	Object secretValue;
	int errorCode;
	String errorMsg;

<span class="fc" id="L75">	String uniqueID = UUID.randomUUID().toString();</span>
<span class="fc" id="L76">	ConjurConfiguration config = new ConjurConfiguration();</span>


	@Override
	public ConjurMuleConnection connect() throws ConnectionException {

<span class="nc" id="L82">		LOGGER.info(&quot;Calling Demo Connection Provider connect()&quot;);</span>

		
		try {
<span class="nc" id="L86">			boolean errorFlag = isValidParameters(conjurAccount, conjurApplianceUrl, conjurAuthnLogin, conjurApiKey,</span>
					conjurSslCertificate);

<span class="nc bnc" id="L89" title="All 2 branches missed.">			if (!errorFlag) {</span>
<span class="nc" id="L90">				config.setConjurAccount(conjurAccount);</span>
<span class="nc" id="L91">				config.setConjurApplianceUrl(conjurApplianceUrl);</span>
<span class="nc" id="L92">				config.setConjurAuthnLogin(conjurAuthnLogin);</span>
<span class="nc" id="L93">				config.setConjurApiKey(conjurApiKey);</span>
<span class="nc" id="L94">				config.setConjurSslCertificate(conjurSslCertificate);</span>
<span class="nc" id="L95">				config.setConjurCertFile(conjurCertFile);</span>
			}

<span class="nc" id="L98">			ConjurConnection.getConnection(config);</span>

<span class="nc" id="L100">			String account = ConjurConnection.getAccount(secretsApi);</span>
<span class="nc" id="L101">			String[] keys = key.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if (keys.length &gt; 1) {</span>
				
<span class="nc" id="L104">				secretValue = conjurService.getBatchSecrets(key, account);</span>

			} else {
<span class="nc" id="L107">				secretValue = conjurService.getSecret(account, ConjurConstant.CONJUR_KIND, key);</span>
			}
			
<span class="nc" id="L110">		} catch (Exception e) {</span>
<span class="nc" id="L111">			throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new ConnectionException(e.getCause()));</span>
<span class="nc" id="L112">		} </span>

<span class="nc" id="L114">		return new ConjurMuleConnection(uniqueID, secretValue,errorCode,errorMsg);</span>

	}

	@Override
	public void disconnect(ConjurMuleConnection connection) {
<span class="fc" id="L120">		connection.invalidate();</span>
<span class="fc" id="L121">	}</span>

	@Override
	public ConnectionValidationResult validate(ConjurMuleConnection connection) {
<span class="fc" id="L125">		return ConnectionValidationResult.success();</span>
	}

	@Validator
	@Throws(ConjurErrorProvider.class)
	public boolean isValidParameters(String conjurAccount, String conjurApplianceUrl, String conjurAuthnLogin,
			String conjurApiKey, String conjurSslCertificate) throws Exception {
<span class="fc" id="L132">		boolean errorFlag = false;</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">		if (StringUtils.isEmpty(conjurAccount)) {</span>
<span class="fc" id="L134">			errorFlag = true;</span>
<span class="fc" id="L135">			throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new Exception(ConjurConstant.INVALID_ACCOUNT));</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		} else if (StringUtils.isEmpty(conjurApplianceUrl)) {</span>
<span class="nc" id="L137">			errorFlag = true;</span>
<span class="nc" id="L138">			throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new Exception(ConjurConstant.INVALID_BASEURL));</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		} else if (StringUtils.isEmpty(conjurAuthnLogin)) {</span>
<span class="nc" id="L140">			errorFlag = true;</span>
<span class="nc" id="L141">			throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new Exception(ConjurConstant.INVALID_USERNAME));</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		} else if (StringUtils.isEmpty(conjurApiKey)) {</span>
<span class="nc" id="L143">			errorFlag = true;</span>
<span class="nc" id="L144">			throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new Exception(ConjurConstant.INVALID_APIKEY));</span>
		} else {
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (StringUtils.isEmpty(conjurSslCertificate)) {</span>
<span class="nc" id="L147">				errorFlag = true;</span>
<span class="nc" id="L148">				throw new ModuleException(ConjurErrorTypes.INVALID_DATA, new Exception(ConjurConstant.INVALID_SSLCERT));</span>
			}
		}
<span class="nc" id="L151">		return errorFlag;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>